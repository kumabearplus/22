<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>瀑布流图片懒加载</title>
  <style type="text/css">
    ul,li {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .ct {
      position: relative;
    }
    .ct>.lists {
      position: relative;
      

    }
    .ct>.lists>li {
/*      width: 200px;*/
      margin: 10px;
      position: absolute;
      transition: all 1s;
/*      display: block;
      float: left;*/
    }
    .ct>.lists>.h1 img {
      height: 200px;
      background-color: yellow;
    }
    .ct>.lists>.h2 img {
      height: 180px;
      background-color: blue;
    }
    .ct>.lists>.h3 img {
      height: 150px;
      background-color: red;
    }
    .ct>.lists img {
      width: 200px;
    }
  </style>
</head>
<body>
  <div class="ct">
    <ul class="lists">
      <li class="h1"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=1"></a></li>
      <li class="h2"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=2"></a></li>
      <li class="h3"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=3"></a></li>
      <li class="h1"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=4"></a></li>
      <li class="h3"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=5"></a></li>
      <li class="h2"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=6"></a></li>
      <li class="h2"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=7"></a></li>
      <li class="h1"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=8"></a></li>
      <li class="h1"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=9"></a></li>
      <li class="h2"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=10"></a></li>
      <li class="h1"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=11"></a></li>
      <li class="h2"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=12"></a></li>
      <li class="h1"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=13"></a></li>
      <li class="h2"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=14"></a></li>
      <li class="h3"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=15"></a></li>
      <li class="h3"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=16"></a></li>
      <li class="h3"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=17"></a></li>
      <li class="h1"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=18"></a></li>
      <li class="h1"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=19"></a></li>
      <li class="h2"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=20"></a></li>
      <li class="h2"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=21"></a></li>
      <li class="h1"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=22"></a></li>
      <li class="h1"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=23"></a></li>
      <li class="h2"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=24"></a></li>
      <li class="h3"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=25"></a></li>
      <li class="h3"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=26"></a></li>
      <li class="h3"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=27"></a></li>
      <li class="h1"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=28"></a></li>
      <li class="h1"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=29"></a></li>
      <li class="h2"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=30"></a></li>
      <li class="h2"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=31"></a></li>
      <li class="h1"><a href="#"><img src='http://p4.so.qhimgs1.com/bdr/_240_/t01875399f7ca17fe54.jpg' data-src="https://unsplash.it/300/200/?random=32"></a></li>
    </ul>
  </div>
  <script src='jquery/jquery-3.2.1.min.js'></script>
  <script type="text/javascript">

    var $ct = $('.ct')
    // var a = 0

    waterFall()

    $('.ct img').each(function(){
      if (isVisible($(this))) {
        showImg($(this))
      }
    })

    $(window).on('scroll',function(){
      $('.ct img').not('.load').each(function(){
        if (isVisible($(this))) {
          showImg($(this))
          // a++
          // console.log(a)
        }
      })

    })
    //waterFall() 放在这里实现不了图片懒加载
    $(window).resize(waterFall)

    function waterFall(){
      var colNum = parseInt($('.lists').width()/$('.lists>li').width())
      var listsArr = []

      for (var i = 0; i < colNum; i++) {
        listsArr[i] = 0
      }

      $('.lists>li').each(function(){
        var minValue = Math.min.apply(null,listsArr)
        var minIndex = listsArr.indexOf(minValue)
        $(this).css({
          top: listsArr[minIndex],
          left: $(this).outerWidth(true)*minIndex
        })
        listsArr[minIndex] += $(this).outerHeight(true)
      })
    }
    
    function showImg ($img){
      var $imgUrl = $img.attr('data-src')
      $img.attr('src',$imgUrl)
      $img.addClass('load')
    }

    function isVisible($node){
      var windowHeight = $(window).height()
      var offsetTop = $node.offset().top
      var scrollTop = $(window).scrollTop()
      var nodeHeight = $node.outerHeight(true)
      if (scrollTop<offsetTop+nodeHeight&&scrollTop>offsetTop-windowHeight) {
        return true
      } else {
        return false
      }
    }

  </script>
</body>
</html>